<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Threat Protector Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="app">
    <!-- Sidebar - WITH CLICK HANDLERS -->
    <div class="sidebar">
      <h2>Threat Protector</h2>
      <div class="nav">
        <div class="nav-item active" onclick="switchTab('email')">Email Security</div>
        <div class="nav-item" onclick="switchTab('password')">Password Health</div>
      </div>
    </div>
    
    <!-- Email Security Tab Content -->
    <div class="dashboard-grid">

      <!-- Card 1: Email Scan Results (MAIN FOCUS) -->
      <div class="dashboard-card">
        <h2>Email Scan Results</h2>
        <div class="scan-stats">
          <div class="stat safe">Safe: <strong>47</strong></div>
          <div class="stat suspicious">Suspicious: <strong>3</strong></div>
          <div class="stat dangerous">Dangerous: <strong>2</strong></div>
        </div>
        <ul id="scan-results">
          <li>Loading emails...</li>
        </ul>
      </div>

      <!-- Card 2: Protection Summary (SIMPLIFIED) -->
      <div class="dashboard-card">
        <h2>Protection Summary</h2>
        <div class="protection-status">
          <p>Total Scanned: <strong id="scan-count">0</strong></p>
          <p>Threats Blocked: <strong id="phishing-count">0</strong></p>
          <p>Risk Level: <strong id="risk-level">--</strong></p>
          <p>Last Scan: <strong id="last-scan-time">Just now</strong></p>
        </div>
        <button class="scan-btn" onclick="loadEmailScanResults()">
          Scan Inbox Now
        </button>
      </div>

    </div>

    <!-- Password Health Tab Content -->
    <div class="dashboard-grid" id="password-health-tab" style="display: none;">

      <!-- Card 1: Password Reuse -->
      <div class="dashboard-card">
        <h2>Password Reuse</h2>
        <div id="reuse-results">
          <div class="password-risk high">
            <strong>"password123"</strong> used on <strong>5 sites</strong>
            <div class="sites-list">facebook.com, twitter.com, instagram.com, gmail.com, netflix.com</div>
          </div>
          <div class="password-risk medium">
            <strong>"Summer2024!"</strong> used on <strong>3 sites</strong>
            <div class="sites-list">amazon.com, paypal.com, spotify.com</div>
          </div>
        </div>
      </div>

      <!-- Card 2: Smart Password Generator -->
      <div class="dashboard-card">
        <h2>ðŸ”§ Smart Password Generator</h2>
        <input type="text" id="password-words" placeholder="Enter words you'll remember (e.g., cat, blue, 2007)" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #444; border-radius: 8px; background: #2a2a2a; color: white;">
        <button class="scan-btn" onclick="generateSmartPassword()" style="width: 100%;">Generate Secure Password</button>
        <div id="password-options" style="margin-top: 20px;"></div>
      </div>

    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // TAB SWITCHING FUNCTIONALITY - ADD THIS FIRST
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.dashboard-grid').forEach(tab => {
        tab.style.display = 'none';
      });
      
      // Remove active class from all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected tab and set active
      if (tabName === 'email') {
        document.querySelector('.dashboard-grid').style.display = 'grid';
        document.querySelectorAll('.nav-item')[0].classList.add('active');
      } else {
        document.getElementById('password-health-tab').style.display = 'grid';
        document.querySelectorAll('.nav-item')[1].classList.add('active');
      }
    }

    // PASSWORD GENERATOR - ADD THIS
    function generateSmartPassword() {
      const userInput = document.getElementById('password-words').value;
      if (!userInput) {
        alert('Please enter some words to include in your password!');
        return;
      }
      
      const words = userInput.split(',').map(word => word.trim()).filter(word => word.length > 0);
      
      if (words.length < 2) {
        alert('Please enter at least 2 words (e.g., "cat, blue, 2007")');
        return;
      }
      
      // Generate password options
      const passwords = [
        `${transformWord(words[0])}${transformWord(words[1])}!${words[2] || '2024'}`,
        `${words[2] || '2024'}_${transformWord(words[0])}_${transformWord(words[1])}!`,
        `$${transformWord(words[0])}${transformWord(words[1])}${words[2] || '24'}`
      ];
      
      // Display options
      const optionsDiv = document.getElementById('password-options');
      optionsDiv.innerHTML = '<h3>ðŸ”’ Generated Passwords:</h3>' + 
        passwords.map((pass, index) => `
          <div style="margin: 10px 0; padding: 12px; background: #2a2a2a; border-radius: 8px; border-left: 4px solid #a855f7;">
            <strong>Option ${index + 1}:</strong> <code style="font-size: 16px;">${pass}</code>
            <button onclick="copyPassword('${pass}')" style="margin-left: 10px; padding: 5px 10px; background: #a855f7; border: none; border-radius: 4px; color: white; cursor: pointer;">ðŸ“‹ Copy</button>
          </div>
        `).join('');
    }

    function transformWord(word) {
      const transformations = {
        'a': '@', 'e': '3', 'i': '!', 'o': '0', 's': '$',
        'l': '1', 't': '7'
      };
      
      let transformed = word.toLowerCase();
      for (const [key, value] of Object.entries(transformations)) {
        transformed = transformed.replace(new RegExp(key, 'g'), value);
      }
      
      // Capitalize first letter
      return transformed.charAt(0).toUpperCase() + transformed.slice(1);
    }

    function copyPassword(password) {
      navigator.clipboard.writeText(password);
      alert('âœ… Password copied to clipboard!');
    }

    // YOUR EXISTING EMAIL SCANNING CODE
    async function loadEmailScanResults() {
      try {
        const res = await fetch('/scan?state=inbox:');
        const data = await res.json();

        const scanList = document.getElementById('scan-results');
        const scanCount = document.getElementById('scan-count');
        const phishingCount = document.getElementById('phishing-count');
        const riskLevel = document.getElementById('risk-level');
        const lastScan = document.getElementById('last-scan-time');

        scanList.innerHTML = '';
        let phishing = 0;

        data.forEach(email => {
          const li = document.createElement('li');
          li.className = `email-threat ${email.risk}`;
          
          li.innerHTML = `
            <div class="email-header">
              <span class="risk-badge ${email.risk}">${email.risk.toUpperCase()}</span>
              <strong>From:</strong> ${email.from}
            </div>
            <div class="email-subject">${email.subject}</div>
            <div class="threat-reason">ðŸš¨ ${getThreatReason(email)}</div>
          `;
          
          scanList.appendChild(li);
          if (email.status.includes("Phishing")) phishing++;
        });

        // Update stats
        scanCount.textContent = data.length;
        phishingCount.textContent = phishing;
        riskLevel.textContent = phishing >= 3 ? 'High' : phishing === 0 ? 'Low' : 'Medium';
        riskLevel.style.color = phishing >= 3 ? 'red' : phishing === 0 ? 'green' : 'orange';
        lastScan.textContent = new Date().toLocaleString();

      } catch (error) {
        console.error('Failed to fetch scan data:', error);
        document.getElementById('scan-results').innerHTML = '<li>Error loading scan results.</li>';
      }
    }

    function getThreatReason(email) {
      if (email.from.includes('amaz0n') || email.from.includes('paypa1')) {
        return "Fake company domain (typosquatting)";
      }
      if (email.subject.toLowerCase().includes('urgent') && email.subject.toLowerCase().includes('password')) {
        return "Urgent password request - common phishing tactic";
      }
      if (email.from.includes('bit.ly') || email.from.includes('tinyurl')) {
        return "URL shortener - hides real destination";
      }
      return "Suspicious patterns detected";
    }

    window.addEventListener('load', loadEmailScanResults);
  </script>
</body>
</html>
